# 10kV 配电线路供电可靠性计算算法逻辑说明书

本文档描述当前实现的供电可靠性计算算法的整体逻辑，包括输入输出、核心常量、处理流程及各阶段公式。实现以 `main.py` / `reliability_framework.py` 及参数文件 `config/reliability_params.json` 为准。

---

## 一、算法目标与适用范围

### 1.1 目标

基于 10kV 配电线路（**主线 + 分支**）的**分段级** Excel 原始数据，自动计算：

- **分段级**：各分段的故障次数、预安排次数、SAIDI-F/S、SAIFI-F/S、SAIDI/SAIFI 合计；
- **线路汇总级**：主线、分支各自的汇总指标及 ASAI；
- **全线路汇总级**：整条线路的 SAIDI、SAIFI、ASAI（按用户数加权）。

计算逻辑符合配电网可靠性评估常用做法，分母采用「线路总用户数」与「全线路总用户数」的区分。

### 1.2 适用范围

- 输入：含「主线」「分支」两个 Sheet 的 Excel，表头可通过参数配置映射；
- 分段：每一行为一个线路分段，具备长度、用户数、线路型号、自动化状态等字段；
- 指标：SAIDI（平均停电时间）、SAIFI（平均停电次数）、ASAI（供电可用率）。

---

## 二、输入与输出

### 2.1 输入

| 来源 | 说明 |
|------|------|
| **输入 Excel**（由执行参数 `-i` 指定） | 至少包含两个 Sheet，名称在参数中配置，默认为主线、分支 |
| **主线 Sheet** | 每行对应一个主线分段，需包含：分段编号来源列、起点是否自动化、长度(km)、用户数量(台)、线路型号 |
| **分支 Sheet** | 每行对应一个分支分段，需包含：分段编号来源列、是否自动化、长度(km)、用户数量(台)、线路型号 |

通过参数文件中的 `field_mappings` 将上述「来源列名」映射为算法内部统一列名（分段编号、自动化状态、长度(km)、用户数(台)、`敷设方式_原始`）。

### 2.2 输出

| 内容 | 说明 |
|------|------|
| **输出 Excel**（由 `-o` 指定或按默认规则生成） | 含 3 个 Sheet 的 xlsx |
| **主线分段明细** | 各主线分段的原始关键信息 + 电缆/架空权重、故障率、隔离时间、故障次数、预安排次数、SAIDI-F/S/合计、SAIFI-F/S/合计 |
| **分支分段明细** | 各分支分段的上述同样指标 |
| **指标汇总** | 三行汇总：主线、分支、全线路的总长度、总用户数、总故障/预安排次数、SAIDI-F/S/合计、SAIFI-F/S/合计、ASAI(%) |

---

## 三、核心常量（参数配置）

所有参与计算的常量由参数文件 `config/reliability_params.json` 中的 **constants** 提供，含义与单位如下。

| 常量名 | 含义 | 单位 | 典型取值 |
|--------|------|------|----------|
| `Cable_Fault_Rate` | 电缆故障率 | 次/(km·年) | 0.09282879 |
| `Overhead_Fault_Rate` | 架空故障率 | 次/(km·年) | 0.15337829 |
| `Auto_Isolation_Time` | 自动化开关隔离时间 | 小时/次 | 0.557 |
| `Manual_Isolation_Time` | 非自动化开关隔离时间 | 小时/次 | 2.0 |
| `Cable_Repair_Time` | 故障修复时间 | 小时/次 | 3.073 |
| `Scheduled_Outage_Rate` | 预安排停电率 | 次/(km·年) | 0.0221 |
| `Scheduled_Total_Time` | 预安排停电总时间 | 小时/次 | 5.475 |
| `Annual_Power_Hours` | 年标准供电时间 | 小时/年 | 8760 |

上述常量在公式中仅通过名称引用，不做硬编码。

---

## 四、整体处理流程

算法按固定顺序执行以下阶段，前一步的输出作为后一步的输入：

```
[输入 Excel] 
    → 1) 读取主线/分支 Sheet 
    → 2) 字段映射（表头 → 内部统一列名）
    → 3) 数据清洗（数值化、异常行过滤）
    → 4) 敷设方式解析 → 电缆/架空权重、加权故障率、隔离时间
    → 5) 线路总用户数（主线、分支、全线路）
    → 6) 分段级可靠性指标（主/支分别算，分母用本线路总用户数）
    → 7) 线路汇总级指标（主线汇总、分支汇总）
    → 8) 全线路加权汇总（SAIDI/SAIFI 按用户数加权，ASAI 按全线路）
    → 9) 写出 Excel（主线分段明细、分支分段明细、指标汇总）
[输出 Excel]
```

以下分阶段说明各步逻辑与公式。

---

## 五、各阶段逻辑说明

### 5.1 字段映射（参数驱动）

将 Excel 表头映射为算法内部统一列名，便于后续步骤只依赖一套列名。

- **主线**：  
  线路分段 → 分段编号；起点是否自动化 → 自动化状态；长度(km)、用户数量(台)、线路型号 → 长度(km)、用户数(台)、`敷设方式_原始`。  
- **分支**：  
  分支分段 → 分段编号；是否自动化 → 自动化状态；长度(km)、用户数量(台)、线路型号 → 长度(km)、用户数(台)、`敷设方式_原始`。

列名与映射关系均由参数 `field_mappings` 配置，无需改代码即可适配不同表头。

### 5.2 数据清洗

- 将 **长度(km)**、**用户数(台)** 转为数值类型（非数值变为缺失）；
- 删除「长度(km)<0」或「用户数(台)<0」的行；
- 删除长度、用户数为缺失的行。

保留行为后续「有效分段」判断与线路总用户数计算提供干净数据。

### 5.3 敷设方式解析与故障率、隔离时间

#### 5.3.1 线路型号解析规则

每个分段的「`敷设方式_原始`」可能为多行文本，每行格式为：`型号名称: 百分比%`。例如：

- `PD_JKLYJ-300: 50.00%\nPD_VLY-8.7/10-3×300: 50.00%`

解析规则：

1. **带 JK**（型号名中包含 "JK"，如 JKLYJ）→ 视为**架空**，其百分比计入架空权重；
2. **None** → 整行忽略，不参与权重与故障率计算；
3. **不带 JK 且非 None** → 视为**电缆**，其百分比计入电缆权重。

#### 5.3.2 加权故障率

对每个分段，在忽略 None 后，用电缆权重 $w_c$ 、架空权重 $w_o$ （满足 $w_c + w_o = 1$ ）计算**加权故障率**：

$$
\lambda = w_c \cdot \texttt{Cable\\_Fault\\_Rate} + w_o \cdot \texttt{Overhead\\_Fault\\_Rate}
$$

该 $\lambda$ 在本分段后续「故障次数」等计算中，作为该段的**故障率**使用。

#### 5.3.3 隔离时间

根据该分段的**自动化状态**（True/False 或字符串 "TRUE"/"FALSE"）取：

- 自动化为真 → `Auto_Isolation_Time`；
- 否则 → `Manual_Isolation_Time`。

得到的隔离时间记为 $t_{\text{iso}}$ ，用于故障总时间计算。

### 5.4 线路总用户数

- **主线总用户数** $N_{主}$ = 主线所有分段「用户数(台)」之和；  
- **分支总用户数** $N_{支}$ = 分支所有分段「用户数(台)」之和；  
- **全线路总用户数** $N_{全}$ = $N_{主}$ + $N_{支}$ 。

 $N_{主}$ 、 $N_{支}$ 用于分段级指标的分母； $N_{全}$ 用于全线路加权与 ASAI。

### 5.5 分段级可靠性指标

仅对「**有效分段**」计算非零指标：**有效分段** = 该分段「用户数(台)」> 0。无效分段各项指标取 0。

以下公式中， $L$ = 分段长度(km)， $n$ = 分段用户数(台)， $\lambda$ = 该段加权故障率， $t_{\text{iso}}$ = 该段隔离时间； $N$ 为**该分段所属线路**的总用户数（主线分段用 $N_{主}$ ，分支分段用 $N_{支}$ ）。

#### 5.5.1 故障类指标

- **故障次数(次/年)**  
  若有效分段：  
  $\text{故障次数} = L \times \lambda$  
  否则：0。

- **故障总时间(小时/次)**  
  $\text{故障总时间} = t_{\text{iso}} + \texttt{Cable\\_Repair\\_Time}$  
  （每段都算，用于公式；无效分段时故障次数为 0，自然不产生停电贡献。）

- **SAIDI-F（故障平均停电时间）**  
  若有效分段且 $N>0$：  
  $\text{SAIDI-F} = \dfrac{\text{故障次数} \times \text{故障总时间} \times n}{N}$  
  否则：0。

- **SAIFI-F（故障平均停电频率）**  
  若有效分段且 $N>0$：  
  $\text{SAIFI-F} = \dfrac{\text{故障次数} \times n}{N}$  
  否则：0。

#### 5.5.2 预安排类指标

- **预安排次数(次/年)**  
  若有效分段：  
  $\text{预安排次数} = L \times \texttt{Scheduled\\_Outage\\_Rate}$  
  否则：0。

- **SAIDI-S（预安排平均停电时间）**  
  若有效分段且 $N>0$：  
  $\text{SAIDI-S} = \dfrac{\text{预安排次数} \times \texttt{Scheduled\\_Total\\_Time} \times n}{N}$  
  否则：0。

- **SAIFI-S（预安排平均停电频率）**  
  若有效分段且 $N>0$：  
  $\text{SAIFI-S} = \dfrac{\text{预安排次数} \times n}{N}$  
  否则：0。

#### 5.5.3 合计

- **SAIDI合计** = SAIDI-F + SAIDI-S  
- **SAIFI合计** = SAIFI-F + SAIFI-S  

以上均在**分段维度**计算，且分母均为**本线路总用户数** $N$ 。

### 5.6 线路汇总级指标（主线 / 分支）

对主线或分支，在其全部分段上做汇总：

- **总长度(km)** = 该线路所有分段「长度(km)」之和；
- **总故障次数(次/年)** = 该线路所有分段「故障次数(次/年)」之和；
- **总预安排次数(次/年)** = 该线路所有分段「预安排次数(次/年)」之和；
- **SAIDI-F** = 该线路所有分段 SAIDI-F 之和（同理 SAIDI-S、SAIFI-F、SAIFI-S）；
- **SAIDI合计** = SAIDI-F + SAIDI-S；
- **SAIFI合计** = SAIFI-F + SAIFI-S。

**ASAI(%)**（以主线为例，分支同理）：

若主线总用户数 $N_{主}$ > 0：

$$
\text{ASAI} = \frac{N_{主} \times \texttt{Annual\\_Power\\_Hours} - \text{SAIDI合计}_{主} \times N_{主}}{N_{主} \times \texttt{Annual\\_Power\\_Hours}} \times 100\%
$$

即：ASAI = (1 − SAIDI合计 / `Annual_Power_Hours`) × 100%。

### 5.7 全线路加权汇总

全线路指标在「主线汇总」与「分支汇总」的基础上，按**用户数**加权得到：

- **总长度(km)** = 主线总长度 + 分支总长度；
- **总用户数(台)** = $N_{全}$ ；
- **总故障次数(次/年)** = 主线总故障次数 + 分支总故障次数；
- **总预安排次数(次/年)** = 主线总预安排次数 + 分支总预安排次数；

- **SAIDI-F** =

$$
\dfrac{\text{SAIDI-F}_{主} \times N_{主} + \text{SAIDI-F}_{支} \times N_{支}}{N_{全}}
$$

  （SAIDI-S、SAIFI-F、SAIFI-S 同理，均为「主线指标× $N_{主}$ + 分支指标× $N_{支}$ 」除以 $N_{全}$ ）；

- **SAIDI合计** = 全线路 SAIDI-F + 全线路 SAIDI-S；  
- **SAIFI合计** = 全线路 SAIFI-F + 全线路 SAIFI-S。

**全线路 ASAI(%)**：

若 $N_{全}$ > 0：

$$
\text{ASAI}_{全} = \frac{N_{全} \times \texttt{Annual\\_Power\\_Hours} - \text{SAIDI合计}_{全} \times N_{全}}{N_{全} \times \texttt{Annual\\_Power\\_Hours}} \times 100\%
$$

等价于：(1 − 全线路 SAIDI合计 / `Annual_Power_Hours`) × 100%。

---

## 六、公式汇总表

| 指标 | 公式或说明 |
|------|------------|
| 加权故障率 $\lambda$ | $w_c \cdot \texttt{Cable\\_Fault\\_Rate} + w_o \cdot \texttt{Overhead\\_Fault\\_Rate}$ ， $w_c+w_o=1$ |
| 故障次数 | $L \times \lambda$（仅有效分段） |
| 故障总时间 | 隔离时间 + `Cable_Repair_Time` |
| SAIDI-F | (故障次数 × 故障总时间 × n) / 本线路总用户数 |
| SAIFI-F | (故障次数 × n) / 本线路总用户数 |
| 预安排次数 | $L \times \texttt{Scheduled\\_Outage\\_Rate}$（仅有效分段） |
| SAIDI-S | (预安排次数 × `Scheduled_Total_Time` × n) / 本线路总用户数 |
| SAIFI-S | (预安排次数 × n) / 本线路总用户数 |
| SAIDI合计 | SAIDI-F + SAIDI-S |
| SAIFI合计 | SAIFI-F + SAIFI-S |
| 线路 ASAI | (1 − SAIDI合计/8760) × 100% |
| 全线路 SAIDI-F/S、SAIFI-F/S | (主线指标× $N_{主}$ + 分支指标× $N_{支}$ ) / $N_{全}$ |
| 全线路 ASAI | (1 − 全线路SAIDI合计/8760) × 100% |

---

## 七、输出结构与实现约定

### 7.1 输出 Excel 的 Sheet

1. **主线分段明细**：分段编号、长度(km)、用户数(台)、电缆权重、架空权重、敷设方式描述、自动化状态、故障率、隔离时间、故障次数(次/年)、故障总时间(小时/次)、预安排次数(次/年)、SAIDI-F、SAIDI-S、SAIDI合计、SAIFI-F、SAIFI-S、SAIFI合计。
2. **分支分段明细**：同上列结构，针对分支分段。
3. **指标汇总**：一行主线汇总、一行分支汇总、一行全线路汇总；列包括线路类型、总长度(km)、总用户数(台)、总故障/预安排次数、SAIDI-F/S/合计、SAIFI-F/S/合计、ASAI(%)。

### 7.2 执行方式

- **输入**：通过命令行 `-i <输入Excel路径>` 指定；
- **输出**：通过 `-o <输出Excel路径>` 指定；未指定时，写入默认目录下「`<输入文件名>_可靠性计算结果.xlsx`」；
- **参数文件**：通过 `-c <参数文件路径>` 指定；未指定时使用 `config/reliability_params.json`。  
参数文件中配置：**constants**、**input** 下的 `main_sheet` / `branch_sheet`、`field_mappings` 等，不包含输入/输出路径。

---

## 八、文档与代码对应关系

- 本文档中的「分段」「线路总用户数」「有效分段」「加权故障率」等定义与 `main.py` / `reliability_framework.py` 的实现保持一致。
- 常量名、字段名与 `config/reliability_params.json` 及代码中使用的键名一致。
- 若参数文件或执行参数（如 `field_mappings`、Sheet 名）变更，仅需在「输入与输出」「核心常量」「字段映射」等小节中同步说明，分段级与汇总级公式不受影响。




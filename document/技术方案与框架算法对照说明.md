# reliability_framework.py 与技术方案算法对照说明

对照文档：  
- `document/技术方案.docx`（10kV 配电线路供电可靠性计算**详细**技术方案）  
- `document/10kV 配电线路供电可靠性计算算法技术方案.docx`（**算法**技术方案）

两份技术方案在**二～五章（核心常量、数据预处理、分段级计算、汇总级计算）**的算法描述一致，以下统一以「技术方案」指代。

---

## 一、已落实的算法（与方案一致）

| 章节 | 方案内容 | 框架实现 | 状态 |
|------|----------|----------|------|
| **二、核心常量** | Auto_Isolation_Time 0.557、Manual_Isolation_Time 2.0、Cable_Repair_Time 3.073、Scheduled_Outage_Rate 0.0221、Scheduled_Total_Time 5.475、Annual_Power_Hours 8760 | 由 `config["constants"]` 读入并在计算中全程使用 | ✅ |
| **二、核心常量** | Cable_Fault_Rate 0.09282879 | 已用 | ✅ |
| **3.1.1 字段映射** | 主线：线路分段→分段编号、起点是否自动化→自动化状态、长度(km)、用户数量(台)→用户数(台)、线路型号→敷设方式 | 由 `field_mappings.main` 配置，逻辑一致 | ✅ |
| **3.1.1 字段映射** | 支线：分支分段→分段编号、是否自动化→自动化状态、长度(km)、用户数量(台)→用户数(台)、线路型号→敷设方式 | 由 `field_mappings.branch` 配置，逻辑一致 | ✅ |
| **3.1.2 数据清洗** | 长度(km)、用户数(台)转为数值；删除长度<0、用户数<0 的异常行 | `clean_data()` 中 `pd.to_numeric` + `(df["长度(km)"]>=0)&(df["用户数(台)"]>=0)` | ✅ |
| **3.1.4 线路总用户数** | 主线/支线/全线路总用户数 = 各分段用户数(台)之和 | 对“用户数(台)”按主/支/全分别 sum，用于分段级分母与汇总 | ✅ |
| **四、分段级指标** | 有效分段 = 用户数>0；无效分段指标=0 | `有效分段 = df["用户数(台)"] > 0`，无效段 SAIDI/SAIFI 等为 0 | ✅ |
| **4.1 故障类** | 故障次数 = 长度(km)×敷设方式对应故障率 | 使用按电缆/架空权重加权的故障率，等价于“敷设方式对应故障率”的推广 | ✅ |
| **4.1 故障类** | 故障总时间 = 隔离时间 + Cable_Repair_Time | `故障总时间(小时/次) = 隔离时间 + constants["Cable_Repair_Time"]` | ✅ |
| **4.1 故障类** | SAIDI-F = (故障次数×故障总时间×分段用户数)÷**线路总用户数** | 分母为**本线路**总用户数（主/支分别），公式一致 | ✅ |
| **4.1 故障类** | SAIFI-F = (故障次数×分段用户数)÷线路总用户数 | 同上，分母为线路总用户数 | ✅ |
| **4.2 预安排类** | 预安排次数 = 长度(km)×Scheduled_Outage_Rate | 已实现，且仅对有效分段计算 | ✅ |
| **4.2 预安排类** | SAIDI-S、SAIFI-S 公式及分母“线路总用户数” | 与方案一致 | ✅ |
| **4.3 合计** | SAIDI合计 = SAIDI-F+SAIDI-S，SAIFI合计 = SAIFI-F+SAIFI-S | 已实现 | ✅ |
| **五、汇总级** | 主线/支线：总长度、总故障次数、总预安排次数、SAIDI-F/S/合计、SAIFI-F/S/合计、ASAI | 汇总方式与方案一致 | ✅ |
| **五、汇总级** | ASAI = (总用户数×Annual_Power_Hours - SAIDI合计×总用户数)÷(总用户数×Annual_Power_Hours)×100% | 主/支/全线路 ASAI 公式一致 | ✅ |
| **5.2 全线路** | SAIDI-F/S、SAIFI-F/S 为 (主线指标×主线用户+支线指标×支线用户)÷全线路用户 | 加权平均实现正确 | ✅ |
| **5.2 全线路** | SAIDI合计=SAIDI-F+SAIDI-S，SAIFI合计=SAIFI-F+SAIFI-S（全线路） | 全线路合计由全线路 SAIDI-F/S、SAIFI-F/S 相加 | ✅ |
| **输出** | 3 个 Sheet：主线分段明细、支线分段明细、可靠性指标汇总 | 现有为：主线分段明细、**分支**分段明细、**指标汇总** | ⚠️ 名称与方案略不同，见下 |

---

## 二、与方案不一致或可再对齐的部分

### 1. 敷设方式与故障率（业务已按新规则实施）

| 项目 | 技术方案 | 当前框架 |
|------|----------|----------|
| 敷设方式分类 | 电缆（YJV/YJLV/YJV22）、**混合**（否则） | **电缆**（不带 JK）、**架空**（带 JK），**None 忽略** |
| 故障率常量 | Cable_Fault_Rate、**Mixed_Fault_Rate 0.108** | Cable_Fault_Rate、**Overhead_Fault_Rate 0.15337829** |
| 故障率用法 | 按“电缆/混合”取单一故障率 | 按线路型号中的占比做**电缆权重×电缆率+架空权重×架空率** |

说明：框架采用的是您后续确定的规则（“带 JK→架空，None 忽略，不带 JK→电缆”及架空率、权重加权），与**两份技术方案正文**的“电缆/混合 + Mixed_Fault_Rate”不一致。若需求以当前业务规则为准，则这里属于**有意变更**，不是算法漏实现；若要以文档为准，需在框架/参数中增加“混合”及 Mixed_Fault_Rate，并恢复“YJV/YJLV/YJV22→电缆、否则→混合”的判定。

### 2. 数据清洗：核心字段缺失行

- **方案 3.1.2**：删除“分段编号、自动化状态等核心字段缺失的行”。  
- **框架**：仅对长度、用户数做了数值化与 ≥0 过滤，**未**显式对分段编号、自动化状态等做缺失删除（如 `dropna(subset=[...])`）。  
- 若需与方案完全一致，建议在清洗阶段对核心字段做 `dropna(subset=["分段编号","自动化状态", ...])`，或在读表后统一过滤空值行。

### 3. 输出 Sheet 名称与方案措辞

- 方案：**支线**分段明细、**可靠性指标汇总**。  
- 框架：**分支**分段明细、**指标汇总**。  
- 为与文档一字不差，可将框架中输出 Sheet 名改为“支线分段明细”“可靠性指标汇总”。

---

## 三、小结

- **公式与计算逻辑**：分段级、汇总级、全线路加权、ASAI 等与两份技术方案中的算法描述**一致**，包括“线路总用户数”的定义与使用方式。  
- **常量**：除“混合/架空”及对应故障率与方案不同外，其余常量（隔离时间、修复时间、预安排率/时间、年供电小时、电缆故障率）与方案一致。  
- **差异点**：  
  1. 敷设方式与故障率按“电缆/架空+权重”实现，与方案中的“电缆/混合”及 Mixed_Fault_Rate 不同，属业务规则调整。  
  2. 未显式实现“删除核心字段缺失行”；  
  3. 输出 Sheet 名称与方案略有不同。  

若需在**不改变当前敷设方式与故障率业务规则**的前提下，尽可能与方案一致，建议仅做：  
- 在数据清洗中增加对核心字段缺失行的删除；  
- 将输出 Sheet 名改为“支线分段明细”“可靠性指标汇总”。
